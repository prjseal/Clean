name: Update NuGet Packages

on:
  workflow_dispatch:
    inputs:
      dryRun:
        description: 'Run without making changes'
        required: false
        default: 'false'
      includePrerelease:
        description: 'Include prerelease versions'
        required: false
        default: 'true'

jobs:
  update-packages:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install GitHub CLI
        run: |
          choco install gh -y

      - name: Run UpdateThirdPartyPackages script
        shell: pwsh
        run: |
          $dryRunFlag = if ('${{ github.event.inputs.dryRun }}' -eq 'true') { $true } else { $false }
          $includePrereleaseFlag = if ('${{ github.event.inputs.includePrerelease }}' -eq 'true') { $true } else { $false }

          Write-Host "DryRunFlag = $dryRunFlag"
          Write-Host "IncludePrereleaseFlag = $includePrereleaseFlag"

          ./UpdateThirdPartyPackages.ps1 `
            -RootPath "${{ github.workspace }}" `
            -DryRun:$dryRunFlag `
            -IncludePrerelease:$includePrereleaseFlag

      - name: Commit and push changes
        id: commit-and-push
        if: ${{ github.event.inputs.dryRun != 'true' }}
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          $branchName = "update-nuget-packages-$(Get-Date -Format 'yyyyMMddHHmmss')"
          echo "branchName=$branchName" >> $env:GITHUB_OUTPUT

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git checkout -b $branchName
          git add .
          if (git diff --cached --quiet) {
            Write-Host "No changes detected. Skipping commit and PR."
            exit 0
          }
          git commit -m "Update NuGet packages"
          git push https://x-access-token:$env:PAT_TOKEN@github.com/${{ github.repository }}.git $branchName

      - name: Create Pull Request
        if: ${{ github.event.inputs.dryRun != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo $env:GITHUB_TOKEN | gh auth login --with-token
          gh pr create `
            --title "Update NuGet packages" `
            --body "This PR updates NuGet packages to the latest versions.`n`n**IncludePrerelease:** ${{ github.event.inputs.includePrerelease }}`n**Triggered by:** ${{ github.actor }}" `
            --base main `
            --head ${{ steps.commit-and-push.outputs.branchName }} `
            --label dependencies --label automated-update
