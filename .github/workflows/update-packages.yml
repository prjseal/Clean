name: Update NuGet Packages

on:
  schedule:
    - cron: '0 8 * * *'  # Run daily at 8am UTC (8am UK time in winter, 9am in summer)
  workflow_dispatch:
    inputs:
      dryRun:
        description: 'Run without making changes'
        required: false
        default: 'false'
      includePrerelease:
        description: 'Include prerelease versions'
        required: false
        default: 'true'

jobs:
  update-packages:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install GitHub CLI
        run: |
          choco install gh -y

      - name: Run UpdateThirdPartyPackages script
        shell: pwsh
        run: |
          $dryRunFlag = if ('${{ github.event.inputs.dryRun }}' -eq 'true') { $true } else { $false }
          $includePrereleaseFlag = if ('${{ github.event.inputs.includePrerelease }}' -eq 'true') { $true } else { $false }

          Write-Host "DryRunFlag = $dryRunFlag"
          Write-Host "IncludePrereleaseFlag = $includePrereleaseFlag"
          ./UpdateThirdPartyPackages.ps1 `
            -RootPath "${{ github.workspace }}" `
            -DryRun:$dryRunFlag `
            -IncludePrerelease:$includePrereleaseFlag

      - name: Commit and push changes
        id: commit-and-push
        if: ${{ github.event.inputs.dryRun != 'true' }}
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          $branchName = "update-nuget-packages-$(Get-Date -Format 'yyyyMMddHHmmss')"
          echo "branchName=$branchName" >> $env:GITHUB_OUTPUT

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git checkout -b $branchName
          git add .
          if (git diff --cached --quiet) {
            Write-Host "No changes detected. Skipping commit and PR."
            exit 0
          }
          git commit -m "Update NuGet packages"
          git push https://x-access-token:$env:PAT_TOKEN@github.com/${{ github.repository }}.git $branchName

      - name: Read package summary
        id: read-summary
        run: |
          $summaryPath = "${{ github.workspace }}\.artifacts\package-summary.txt"
          if (Test-Path $summaryPath) {
            $content = Get-Content $summaryPath -Raw
            echo "summary<<EOF" >> $env:GITHUB_OUTPUT
            echo "$content" >> $env:GITHUB_OUTPUT
            echo "EOF" >> $env:GITHUB_OUTPUT
          } else {
            echo "summary<<EOF" >> $env:GITHUB_OUTPUT
            echo "No package summary found." >> $env:GITHUB_OUTPUT
            echo "EOF" >> $env:GITHUB_OUTPUT
          }

      - name: Check for existing similar PRs
        id: check-existing-pr
        if: ${{ github.event.inputs.dryRun != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo $env:GITHUB_TOKEN | gh auth login --with-token

          # Get current package summary from file
          $summaryPath = "${{ github.workspace }}\.artifacts\package-summary.txt"
          $currentSummary = Get-Content $summaryPath -Raw

          # List all open PRs with branches matching our pattern
          $existingPRs = gh pr list --state open --json number,headRefName,body --limit 100 | ConvertFrom-Json

          $skipPR = $false
          $matchingPR = $null

          foreach ($pr in $existingPRs) {
            if ($pr.headRefName -like "update-nuget-packages-*") {
              # Extract the package table from the PR body
              $prBody = $pr.body

              # Extract content between triple backticks (the package table)
              if ($prBody -match '(?s)```(.+?)```') {
                $prPackages = $matches[1].Trim()

                # Compare with current summary (normalize whitespace for comparison)
                $currentNormalized = $currentSummary.Trim() -replace '\s+', ' '
                $prNormalized = $prPackages -replace '\s+', ' '

                if ($currentNormalized -eq $prNormalized) {
                  $skipPR = $true
                  $matchingPR = $pr.number
                  Write-Host "Found existing PR #$matchingPR with identical package updates. Skipping PR creation."
                  break
                }
              }
            }
          }

          echo "skip=$skipPR" >> $env:GITHUB_OUTPUT
          echo "existing_pr_number=$matchingPR" >> $env:GITHUB_OUTPUT

      - name: Create Pull Request
        if: ${{ github.event.inputs.dryRun != 'true' && steps.check-existing-pr.outputs.skip != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo $env:GITHUB_TOKEN | gh auth login --with-token

          # Create PR body in a file to avoid escaping issues
          $prBodyFile = "${{ github.workspace }}\.artifacts\pr-body.md"

          # Write PR body content line by line
          "This PR updates NuGet packages to the latest versions." | Out-File -FilePath $prBodyFile -Encoding UTF8
          "" | Out-File -FilePath $prBodyFile -Encoding UTF8 -Append
          "**IncludePrerelease:** ${{ github.event.inputs.includePrerelease }}" | Out-File -FilePath $prBodyFile -Encoding UTF8 -Append
          "**Triggered by:** ${{ github.actor }}" | Out-File -FilePath $prBodyFile -Encoding UTF8 -Append
          "" | Out-File -FilePath $prBodyFile -Encoding UTF8 -Append
          "### Updated Packages:" | Out-File -FilePath $prBodyFile -Encoding UTF8 -Append
          "``````" | Out-File -FilePath $prBodyFile -Encoding UTF8 -Append
          "${{ steps.read-summary.outputs.summary }}" | Out-File -FilePath $prBodyFile -Encoding UTF8 -Append
          "``````" | Out-File -FilePath $prBodyFile -Encoding UTF8 -Append

          gh pr create `
            --title "Update NuGet packages" `
            --body-file $prBodyFile `
            --base main `
            --head ${{ steps.commit-and-push.outputs.branchName }}

      - name: Summary - PR Skipped
        if: ${{ github.event.inputs.dryRun != 'true' && steps.check-existing-pr.outputs.skip == 'true' }}
        run: |
          Write-Host "================================================" -ForegroundColor Yellow
          Write-Host "PR CREATION SKIPPED" -ForegroundColor Yellow
          Write-Host "================================================" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "An existing PR (#${{ steps.check-existing-pr.outputs.existing_pr_number }}) already has identical package updates." -ForegroundColor Cyan
          Write-Host "No need to create a duplicate PR." -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Existing PR: https://github.com/${{ github.repository }}/pull/${{ steps.check-existing-pr.outputs.existing_pr_number }}" -ForegroundColor Green
          Write-Host "================================================" -ForegroundColor Yellow
