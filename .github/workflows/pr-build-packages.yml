name: PR - Build NuGet Packages

on:
  pull_request_target:
    branches:
      - main

jobs:
  build-packages:
    runs-on: windows-latest
    permissions:
      contents: read
      packages: write
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Configure custom NuGet sources from PR description
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./.github/workflows/powershell/Configure-CustomNuGetSources.ps1 -PrNumber "${{ github.event.pull_request.number }}"

      - name: Get latest NuGet version and create build version
        id: version
        shell: pwsh
        run: |
          ./.github/workflows/powershell/Get-BuildVersion.ps1 -BuildNumber "${{ github.run_number }}" -WorkspacePath "${{ github.workspace }}"

      - name: Display version info
        shell: pwsh
        run: |
          ./.github/workflows/powershell/Show-BuildVersionInfo.ps1 -BaseVersion "${{ steps.version.outputs.base_version }}" -BuildNumber "${{ github.run_number }}" -FullVersion "${{ steps.version.outputs.version }}"

      # Documentation: .github/CreateNuGetPackages-Documentation.md
      # This script creates NuGet packages by starting Umbraco, downloading package via API,
      # applying BlockList label fixes, updating .csproj versions, and building all packages.
      - name: Run CreateNuGetPackages script
        shell: pwsh
        run: |
          Write-Host "Running CreateNuGetPackages.ps1 with version ${{ steps.version.outputs.version }}"
          ./.github/workflows/powershell/CreateNuGetPackages.ps1 -Version "${{ steps.version.outputs.version }}"

      - name: Upload NuGet packages as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages-${{ steps.version.outputs.version }}
          path: .artifacts/nuget/*.nupkg
          if-no-files-found: warn

      - name: Publish to GitHub Packages
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./.github/workflows/powershell/Publish-ToGitHubPackages.ps1 -GitHubToken $env:GITHUB_TOKEN -RepositoryOwner "${{ github.repository_owner }}"

      - name: Test Package Installation and Site
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./.github/workflows/powershell/Test-PackageInstallation.ps1 -Version "${{ steps.version.outputs.version }}" -WorkspacePath "${{ github.workspace }}"

      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: package-test-screenshots-${{ steps.version.outputs.version }}
          path: test-installation/screenshots/*.png
          if-no-files-found: warn

      - name: Test Template Installation and Site
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./.github/workflows/powershell/Test-TemplateInstallation.ps1 -Version "${{ steps.version.outputs.version }}" -WorkspacePath "${{ github.workspace }}"

      - name: Upload Template Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: template-screenshots-${{ steps.version.outputs.version }}
          path: test-template-TestTemplateProject/TestTemplateProject/screenshots/*.png
          if-no-files-found: warn

      - name: Test Template with Period in Name - Verify Fix for Issue #11
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host "Testing Template with Period in Name (Issue #11 Fix)" -ForegroundColor Cyan
          Write-Host "================================================" -ForegroundColor Cyan
          ./.github/workflows/powershell/Test-TemplateInstallation.ps1 -Version "${{ steps.version.outputs.version }}" -WorkspacePath "${{ github.workspace }}" -ProjectName "Company.Website"

      - name: Upload Period Name Test Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: period-name-test-screenshots-${{ steps.version.outputs.version }}
          path: test-template-Company-Website/Company.Website/screenshots/*.png
          if-no-files-found: warn

      - name: Build Summary
        if: always()
        shell: pwsh
        run: |
          ./.github/workflows/powershell/Show-BuildSummary.ps1 -Version "${{ steps.version.outputs.version }}" -PrNumber "${{ github.event.pull_request.number }}" -Branch "${{ github.head_ref }}" -Actor "${{ github.actor }}" -Repository "${{ github.repository }}"
