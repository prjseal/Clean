name: PR - Build NuGet Packages

on:
  pull_request:
    branches:
      - main

jobs:
  build-packages:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Get latest NuGet version and create build version
        id: version
        shell: pwsh
        run: |
          # Query NuGet API for the latest version of the Clean package
          $packageId = "Clean"
          $nugetApiUrl = "https://api.nuget.org/v3-flatcontainer/$packageId/index.json"

          Write-Host "Fetching latest version for package: $packageId"

          try {
            $response = Invoke-RestMethod -Uri $nugetApiUrl -ErrorAction Stop
            $versions = $response.versions

            Write-Host "Found $($versions.Count) total versions"

            # Parse and sort versions using semantic versioning
            $parsedVersions = $versions | ForEach-Object {
              $versionString = $_
              $prerelease = ""

              # Split on hyphen to separate version from prerelease tag
              if ($versionString -match '^([0-9]+\.[0-9]+\.[0-9]+)(.*)$') {
                $baseVersion = $matches[1]
                $prerelease = $matches[2]
              } else {
                $baseVersion = $versionString
              }

              # Create object for sorting
              [PSCustomObject]@{
                Original = $versionString
                Version = [Version]$baseVersion
                Prerelease = $prerelease
                IsPrerelease = $prerelease -ne ""
              }
            }

            # Sort by version (descending), then by prerelease status (stable first)
            # This ensures 7.0.0 comes before 7.0.0-rc, but 7.0.0-rc comes before 6.x.x
            $sortedVersions = $parsedVersions | Sort-Object -Property @{Expression={$_.Version}; Descending=$true}, @{Expression={$_.IsPrerelease}; Descending=$false}

            # Get the highest version (could be stable or prerelease)
            $latestVersion = $sortedVersions[0].Original

            # Strip prerelease suffix (everything from - onwards) for the base version
            $baseVersionOnly = $sortedVersions[0].Version

            # If there's no prerelease suffix, increment the patch version
            if (-not $sortedVersions[0].IsPrerelease) {
              $major = $baseVersionOnly.Major
              $minor = $baseVersionOnly.Minor
              $patch = $baseVersionOnly.Build + 1
              $baseVersionOnly = [Version]::new($major, $minor, $patch)
              Write-Host "Latest is stable release, incrementing patch version"
            } else {
              Write-Host "Latest is prerelease, using base version without suffix"
            }

            $baseVersionString = $baseVersionOnly.ToString()

            Write-Host "Latest version found: $latestVersion"
            Write-Host "  Version number: $($sortedVersions[0].Version)"
            Write-Host "  Is prerelease: $($sortedVersions[0].IsPrerelease)"
            Write-Host "  Base version for builds: $baseVersionString"

            # Create build version: {baseVersionString}.{buildNumber}
            $buildNumber = "${{ github.run_number }}"
            $buildVersion = "$baseVersionString.$buildNumber"

            Write-Host "Build version: $buildVersion"

            # Output the version for use in subsequent steps
            echo "version=$buildVersion" >> $env:GITHUB_OUTPUT
            echo "base_version=$baseVersionString" >> $env:GITHUB_OUTPUT
          }
          catch {
            Write-Host "Error fetching version from NuGet: $_"
            Write-Host "Using default version: 1.0.0.$buildNumber"
            $buildNumber = "${{ github.run_number }}"
            $buildVersion = "1.0.0.$buildNumber"
            echo "version=$buildVersion" >> $env:GITHUB_OUTPUT
            echo "base_version=1.0.0" >> $env:GITHUB_OUTPUT
          }

      - name: Display version info
        run: |
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host "Build Version Information" -ForegroundColor Cyan
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host "Base Version: ${{ steps.version.outputs.base_version }}" -ForegroundColor Green
          Write-Host "Build Number: ${{ github.run_number }}" -ForegroundColor Green
          Write-Host "Full Version: ${{ steps.version.outputs.version }}" -ForegroundColor Yellow
          Write-Host "================================================" -ForegroundColor Cyan

      - name: Run CreateNuGetPackages script
        shell: pwsh
        run: |
          Write-Host "Running CreateNuGetPackages.ps1 with version ${{ steps.version.outputs.version }}"
          ./CreateNuGetPackages.ps1 -Version "${{ steps.version.outputs.version }}"

      - name: Upload NuGet packages as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages-${{ steps.version.outputs.version }}
          path: .artifacts/nuget/*.nupkg
          if-no-files-found: warn

      - name: Publish to GitHub Packages
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host "Publishing NuGet Packages to GitHub Packages" -ForegroundColor Cyan
          Write-Host "================================================" -ForegroundColor Cyan

          # Get all package files
          $packages = Get-ChildItem -Path ".artifacts/nuget/*.nupkg" -ErrorAction SilentlyContinue

          if (-not $packages) {
            Write-Host "No packages found to publish." -ForegroundColor Yellow
            exit 0
          }

          Write-Host "Found $($packages.Count) package(s) to publish:" -ForegroundColor Green
          foreach ($pkg in $packages) {
            Write-Host "  - $($pkg.Name)" -ForegroundColor White
          }
          Write-Host ""

          # Add GitHub Packages source
          $sourceUrl = "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"
          Write-Host "Adding GitHub Packages source: $sourceUrl" -ForegroundColor Cyan
          dotnet nuget add source $sourceUrl --name "GitHubPackages" --username "${{ github.repository_owner }}" --password "$env:GITHUB_TOKEN" --store-password-in-clear-text

          # Push each package
          foreach ($pkg in $packages) {
            Write-Host "Publishing $($pkg.Name)..." -ForegroundColor Cyan
            dotnet nuget push $pkg.FullName --source "GitHubPackages" --api-key "$env:GITHUB_TOKEN" --skip-duplicate

            if ($LASTEXITCODE -eq 0) {
              Write-Host "✅ Successfully published $($pkg.Name)" -ForegroundColor Green
            } else {
              Write-Host "⚠️  Failed to publish $($pkg.Name) (exit code: $LASTEXITCODE)" -ForegroundColor Yellow
            }
          }

          Write-Host ""
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host "Package Publishing Complete" -ForegroundColor Cyan
          Write-Host "================================================" -ForegroundColor Cyan

      - name: Build Summary
        if: always()
        run: |
          Write-Host "================================================" -ForegroundColor Green
          Write-Host "Build Summary" -ForegroundColor Green
          Write-Host "================================================" -ForegroundColor Green
          Write-Host "Version: ${{ steps.version.outputs.version }}" -ForegroundColor Cyan
          Write-Host "PR Number: ${{ github.event.pull_request.number }}" -ForegroundColor Cyan
          Write-Host "Branch: ${{ github.head_ref }}" -ForegroundColor Cyan
          Write-Host "Triggered by: ${{ github.actor }}" -ForegroundColor Cyan
          Write-Host "================================================" -ForegroundColor Green

          # List generated packages
          $packages = Get-ChildItem -Path ".artifacts/nuget/*.nupkg" -ErrorAction SilentlyContinue
          if ($packages) {
            Write-Host "`nGenerated Packages:" -ForegroundColor Yellow
            foreach ($pkg in $packages) {
              Write-Host "  - $($pkg.Name)" -ForegroundColor White
            }
            Write-Host "`nPublished to: https://github.com/${{ github.repository }}/packages" -ForegroundColor Cyan
          } else {
            Write-Host "`nNo packages were generated." -ForegroundColor Red
          }
