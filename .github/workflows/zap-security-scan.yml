name: PR - OWASP ZAP Security Scan

on:
  pull_request_review:
    types: [submitted]
    branches:
      - main
  workflow_dispatch:
    inputs:
      template-source:
        description: 'Clean template source'
        required: false
        type: choice
        options:
          - nuget
          - github-packages
          - code
        default: nuget
      template-version:
        description: 'Clean template version to test (leave blank for latest)'
        required: false
        type: string
  schedule:
    # Run nightly at 2:00 AM UTC
    - cron: '0 2 * * *'

jobs:
  zap-security-scan:
    # Only run on approved PR reviews or other triggers, and only in the origin repository
    if: (github.event_name != 'pull_request_review' || github.event.review.state == 'approved') && github.repository == 'prjseal/Clean'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      pull-requests: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          fetch-depth: 0

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Clean Template Site for ZAP Testing
        id: setup-site
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $params = @{
            WorkspacePath = "${{ github.workspace }}"
          }

          # Determine template source based on trigger type
          $templateSource = switch ("${{ github.event_name }}") {
            "pull_request_review" {
              Write-Host "Trigger: PR Review - Using 'code' template source" -ForegroundColor Cyan
              "code"
            }
            "schedule" {
              Write-Host "Trigger: Scheduled - Using 'nuget' template source" -ForegroundColor Cyan
              "nuget"
            }
            default {
              if ("${{ inputs.template-source }}" -ne "") {
                Write-Host "Trigger: Manual - Using '${{ inputs.template-source }}' template source" -ForegroundColor Cyan
                "${{ inputs.template-source }}"
              } else {
                Write-Host "Trigger: Manual - Using default 'nuget' template source" -ForegroundColor Cyan
                "nuget"
              }
            }
          }
          $params.TemplateSource = $templateSource

          if ("${{ inputs.template-version }}" -ne "") {
            $params.TemplateVersion = "${{ inputs.template-version }}"
          }
          ./.github/workflows/powershell/Test-LatestWithZap.ps1 @params

      - name: Sanitize Version Numbers for Artifact Names
        id: sanitize-versions
        shell: bash
        run: |
          ./.github/workflows/scripts/sanitize-version-numbers.sh "${{ steps.setup-site.outputs.clean_template_version }}"

      - name: Wait for Site Readiness
        run: |
          ./.github/workflows/scripts/wait-site-readiness.sh "${{ steps.setup-site.outputs.site_url }}"

      - name: Run OWASP ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.13.0
        continue-on-error: true
        with:
          target: ${{ steps.setup-site.outputs.site_url }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
          allow_issue_writing: false
          fail_action: false

      - name: Upload ZAP Scan Report (HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-report-html-clean-template-${{ steps.sanitize-versions.outputs.template_version_safe }}
          path: |
            report_html.html
            report.html
          if-no-files-found: warn

      - name: Upload ZAP Scan Report (Markdown)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-report-markdown-clean-template-${{ steps.sanitize-versions.outputs.template_version_safe }}
          path: |
            report_md.md
            report.md
          if-no-files-found: warn

      - name: Upload ZAP Scan Report (JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-report-json-clean-template-${{ steps.sanitize-versions.outputs.template_version_safe }}
          path: |
            report_json.json
            report.json
          if-no-files-found: warn

      - name: Upload Site Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: site-logs-clean-template-${{ steps.sanitize-versions.outputs.template_version_safe }}
          path: |
            ${{ steps.setup-site.outputs.test_dir }}/site.log
            ${{ steps.setup-site.outputs.test_dir }}/site.err
          if-no-files-found: warn

      - name: Cleanup - Stop Umbraco Site
        if: always()
        shell: pwsh
        run: |
          ./.github/workflows/powershell/Stop-UmbracoSite.ps1 -SitePid "${{ steps.setup-site.outputs.site_pid }}"

      - name: ZAP Scan Summary
        if: always()
        run: |
          ./.github/workflows/scripts/create-zap-scan-summary.sh \
            "${{ steps.setup-site.outputs.branch_name || github.ref_name }}" \
            "${{ steps.setup-site.outputs.template_source }}" \
            "${{ steps.setup-site.outputs.clean_template_version }}" \
            "${{ steps.setup-site.outputs.site_url }}" \
            "${{ steps.setup-site.outputs.umbraco_cms_version }}" \
            "${{ steps.create-issues.outputs.issues_created }}"

      - name: Create GitHub Issues for ZAP Alerts
        id: create-issues
        if: always() && hashFiles('report_json.json') != ''
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Creating GitHub issues for ZAP security alerts..." -ForegroundColor Cyan

          # Build PR URL if triggered from PR review
          $prUrl = ""
          if ("${{ github.event_name }}" -eq "pull_request_review") {
            $prUrl = "https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"
          }

          # Run the issue creation script with all metadata
          $params = @{
            ReportPath = "report_json.json"
            Repository = "${{ github.repository }}"
            Token = "$env:GITHUB_TOKEN"
            BranchName = "${{ steps.setup-site.outputs.branch_name || github.ref_name }}"
            TemplateSource = "${{ steps.setup-site.outputs.template_source }}"
            TemplateVersion = "${{ steps.setup-site.outputs.clean_template_version }}"
          }

          if ("${{ steps.setup-site.outputs.umbraco_cms_version }}" -ne "") {
            $params.UmbracoCmsVersion = "${{ steps.setup-site.outputs.umbraco_cms_version }}"
          }

          if ($prUrl -ne "") {
            $params.PullRequestUrl = $prUrl
          }

          ./.github/workflows/powershell/Create-ZapAlertIssues.ps1 @params

      - name: Fail Check if Code Template Created Issues
        if: steps.setup-site.outputs.template_source == 'code' && steps.create-issues.outputs.issues_created != '' && steps.create-issues.outputs.issues_created != '0'
        run: |
          echo "::error::Security scan found issues when testing local repository code. ${{ steps.create-issues.outputs.issues_created }} new issue(s) were created."
          echo "### âŒ Security Check Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The security scan found **${{ steps.create-issues.outputs.issues_created }}** new security issue(s) when testing the local repository code." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review and fix these issues before merging." >> $GITHUB_STEP_SUMMARY
          exit 1
