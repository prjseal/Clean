name: PR - OWASP ZAP Security Scan

on:
  pull_request_review:
    types: [submitted]
    branches:
      - main
  workflow_dispatch:
    inputs:
      template-source:
        description: 'Clean template source'
        required: false
        type: choice
        options:
          - nuget
          - github-packages
          - code
        default: nuget
      template-version:
        description: 'Clean template version to test (leave blank for latest)'
        required: false
        type: string
  schedule:
    # Run nightly at 2:00 AM UTC
    - cron: '0 2 * * *'

jobs:
  zap-security-scan:
    # Only run on approved PR reviews or other triggers
    if: github.event_name != 'pull_request_review' || github.event.review.state == 'approved'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      pull-requests: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          fetch-depth: 0

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Clean Template Site for ZAP Testing
        id: setup-site
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $params = @{
            WorkspacePath = "${{ github.workspace }}"
          }

          # Determine template source based on trigger type
          $templateSource = switch ("${{ github.event_name }}") {
            "pull_request_review" {
              Write-Host "Trigger: PR Review - Using 'code' template source" -ForegroundColor Cyan
              "code"
            }
            "schedule" {
              Write-Host "Trigger: Scheduled - Using 'nuget' template source" -ForegroundColor Cyan
              "nuget"
            }
            default {
              if ("${{ inputs.template-source }}" -ne "") {
                Write-Host "Trigger: Manual - Using '${{ inputs.template-source }}' template source" -ForegroundColor Cyan
                "${{ inputs.template-source }}"
              } else {
                Write-Host "Trigger: Manual - Using default 'nuget' template source" -ForegroundColor Cyan
                "nuget"
              }
            }
          }
          $params.TemplateSource = $templateSource

          if ("${{ inputs.template-version }}" -ne "") {
            $params.TemplateVersion = "${{ inputs.template-version }}"
          }
          ./.github/workflows/powershell/Test-LatestWithZap.ps1 @params

      - name: Sanitize Version Numbers for Artifact Names
        id: sanitize-versions
        shell: bash
        run: |
          # Replace dots with dashes for artifact naming (GitHub Actions requirement)
          TEMPLATE_VERSION_SAFE="${{ steps.setup-site.outputs.clean_template_version }}"
          TEMPLATE_VERSION_SAFE="${TEMPLATE_VERSION_SAFE//./-}"
          echo "template_version_safe=${TEMPLATE_VERSION_SAFE}" >> $GITHUB_OUTPUT

      - name: Wait for Site Readiness
        run: |
          echo "Waiting additional time to ensure site is fully ready for ZAP scan..."
          sleep 5
          echo "Site URL: ${{ steps.setup-site.outputs.site_url }}"
          echo "Testing site connectivity..."

          # Convert HTTPS to HTTP if needed (ZAP works better with HTTP for local testing)
          SITE_URL="${{ steps.setup-site.outputs.site_url }}"
          if [[ $SITE_URL == https://* ]]; then
            HTTP_URL="${SITE_URL/https/http}"
            echo "Attempting to connect to: $HTTP_URL"

            # Try a simple curl to verify the site is responding
            for i in {1..10}; do
              if curl -k -s -o /dev/null -w "%{http_code}" "$SITE_URL" | grep -q "200\|302"; then
                echo "Site is responding!"
                break
              fi
              echo "Waiting for site to respond (attempt $i/10)..."
              sleep 3
            done
          fi

      - name: Run OWASP ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.13.0
        continue-on-error: true
        with:
          target: ${{ steps.setup-site.outputs.site_url }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
          allow_issue_writing: false
          fail_action: false

      - name: Upload ZAP Scan Report (HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-report-html-clean-template-${{ steps.sanitize-versions.outputs.template_version_safe }}
          path: |
            report_html.html
            report.html
          if-no-files-found: warn

      - name: Upload ZAP Scan Report (Markdown)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-report-markdown-clean-template-${{ steps.sanitize-versions.outputs.template_version_safe }}
          path: |
            report_md.md
            report.md
          if-no-files-found: warn

      - name: Upload ZAP Scan Report (JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-report-json-clean-template-${{ steps.sanitize-versions.outputs.template_version_safe }}
          path: |
            report_json.json
            report.json
          if-no-files-found: warn

      - name: Upload Site Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: site-logs-clean-template-${{ steps.sanitize-versions.outputs.template_version_safe }}
          path: |
            ${{ steps.setup-site.outputs.test_dir }}/site.log
            ${{ steps.setup-site.outputs.test_dir }}/site.err
          if-no-files-found: warn

      - name: Cleanup - Stop Umbraco Site
        if: always()
        shell: pwsh
        run: |
          $sitePid = "${{ steps.setup-site.outputs.site_pid }}"

          if ($sitePid) {
            Write-Host "Stopping site process (PID: $sitePid)..." -ForegroundColor Yellow

            try {
              # Check if process exists and is running
              $process = Get-Process -Id $sitePid -ErrorAction SilentlyContinue

              if ($process) {
                Stop-Process -Id $sitePid -Force -ErrorAction SilentlyContinue
                Write-Host "Site process stopped successfully" -ForegroundColor Green
              } else {
                Write-Host "Site process already exited" -ForegroundColor Yellow
              }
            } catch {
              Write-Host "Error stopping process: $($_.Exception.Message)" -ForegroundColor Yellow
            }
          } else {
            Write-Host "No site PID found, skipping cleanup" -ForegroundColor Yellow
          }

      - name: ZAP Scan Summary
        if: always()
        run: |
          echo "## OWASP ZAP Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ steps.setup-site.outputs.branch_name || github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Template Source:** ${{ steps.setup-site.outputs.template_source }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Clean Template Version:** ${{ steps.setup-site.outputs.clean_template_version }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.setup-site.outputs.umbraco_cms_version }}" ]; then
            echo "- **Umbraco CMS Version:** ${{ steps.setup-site.outputs.umbraco_cms_version }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Target URL:** ${{ steps.setup-site.outputs.site_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Project Type:** Clean Blog (from Umbraco.Community.Templates.Clean)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Include the full ZAP scan results in the summary
          if [ -f "report_md.md" ]; then
            echo "### Security Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat report_md.md >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Warning:** Scan report not found. Please check the artifacts for detailed results." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Downloadable Reports" >> $GITHUB_STEP_SUMMARY
          echo "Full scan reports have been uploaded as artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ HTML Report (detailed with styling)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Markdown Report (text-based)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ Site Logs (for debugging)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.setup-site.outputs.template_source }}" = "code" ]; then
            echo "âš ï¸ **Note:** When testing local repository code, this workflow will fail if new security issues are found." >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Note:** This workflow does not fail on security findings when testing published templates. Please review the results above and in the artifacts." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create GitHub Issues for ZAP Alerts
        id: create-issues
        if: always() && hashFiles('report_json.json') != ''
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Creating GitHub issues for ZAP security alerts..." -ForegroundColor Cyan

          # Build PR URL if triggered from PR review
          $prUrl = ""
          if ("${{ github.event_name }}" -eq "pull_request_review") {
            $prUrl = "https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"
          }

          # Run the issue creation script with all metadata
          $params = @{
            ReportPath = "report_json.json"
            Repository = "${{ github.repository }}"
            Token = "$env:GITHUB_TOKEN"
            BranchName = "${{ steps.setup-site.outputs.branch_name || github.ref_name }}"
            TemplateSource = "${{ steps.setup-site.outputs.template_source }}"
            TemplateVersion = "${{ steps.setup-site.outputs.clean_template_version }}"
          }

          if ("${{ steps.setup-site.outputs.umbraco_cms_version }}" -ne "") {
            $params.UmbracoCmsVersion = "${{ steps.setup-site.outputs.umbraco_cms_version }}"
          }

          if ($prUrl -ne "") {
            $params.PullRequestUrl = $prUrl
          }

          ./.github/workflows/powershell/Create-ZapAlertIssues.ps1 @params

      - name: Fail Check if Code Template Created Issues
        if: steps.setup-site.outputs.template_source == 'code' && steps.create-issues.outputs.issues_created != '' && steps.create-issues.outputs.issues_created != '0'
        run: |
          echo "::error::Security scan found issues when testing local repository code. ${{ steps.create-issues.outputs.issues_created }} new issue(s) were created."
          echo "### âŒ Security Check Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The security scan found **${{ steps.create-issues.outputs.issues_created }}** new security issue(s) when testing the local repository code." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review and fix these issues before merging." >> $GITHUB_STEP_SUMMARY
          exit 1
