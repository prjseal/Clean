name: Release - Publish to NuGet.org

on:
  release:
    types: [published]

jobs:
  publish-release:
    if: github.repository == 'prjseal/Clean'
    runs-on: windows-latest
    permissions:
      contents: write       # Allow pushing branches and uploading release assets
      pull-requests: write  # Allow creating pull requests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Extract version from release tag
        id: version
        shell: pwsh
        run: |
          ./.github/workflows/powershell/Extract-ReleaseVersion.ps1 -ReleaseTag "${{ github.event.release.tag_name }}" -IsPrerelease "${{ github.event.release.prerelease }}"

      - name: Display version info
        shell: pwsh
        run: |
          ./.github/workflows/powershell/Show-VersionInfo.ps1 -ReleaseTag "${{ github.event.release.tag_name }}" -Version "${{ steps.version.outputs.version }}" -IsPrerelease "${{ steps.version.outputs.is_prerelease }}" -ReleaseName "${{ github.event.release.name }}"

      - name: Update README files with latest versions
        shell: pwsh
        run: |
          ./.github/workflows/powershell/Update-ReadmeVersions.ps1 -Version "${{ steps.version.outputs.version }}"

      # Documentation: .github/CreateNuGetPackages-Documentation.md
      # This script creates NuGet packages by starting Umbraco, downloading package via API,
      # applying BlockList label fixes, updating .csproj versions, and building all packages.
      - name: Run CreateNuGetPackages script
        shell: pwsh
        run: |
          Write-Host "Running CreateNuGetPackages.ps1 with version ${{ steps.version.outputs.version }}"
          ./.github/workflows/powershell/CreateNuGetPackages.ps1 -Version "${{ steps.version.outputs.version }}"

      - name: Upload NuGet packages as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages-${{ steps.version.outputs.version }}
          path: .artifacts/nuget/*.nupkg
          if-no-files-found: error

      - name: Publish to NuGet.org
        shell: pwsh
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          ./.github/workflows/powershell/Publish-ToNuGet.ps1 -ApiKey $env:NUGET_API_KEY

      - name: Add packages to release assets
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./.github/workflows/powershell/Add-ReleaseAssets.ps1 -ReleaseTag "${{ github.event.release.tag_name }}"

      - name: Create PR with version updates
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./.github/workflows/powershell/New-VersionUpdatePullRequest.ps1 -Version "${{ steps.version.outputs.version }}" -IsPrerelease "${{ steps.version.outputs.is_prerelease }}" -ReleaseUrl "${{ github.event.release.html_url }}"

      - name: Release Summary
        if: always()
        shell: pwsh
        run: |
          ./.github/workflows/powershell/Show-ReleaseSummary.ps1 -Version "${{ steps.version.outputs.version }}" -ReleaseTag "${{ github.event.release.tag_name }}" -IsPrerelease "${{ steps.version.outputs.is_prerelease }}" -ReleaseUrl "${{ github.event.release.html_url }}"
